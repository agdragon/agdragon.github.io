	<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>WSGI初探 | agdragon&#39;s journal</title>
  <meta name="author" content="agdragon">
  
  <meta name="description" content="记录|分享">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="WSGI初探"/>
  <meta property="og:site_name" content="agdragon&#39;s journal"/>

  
  
		<!-- favicon -->
		<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
		<link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png">
		<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
		<link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png">
		<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
		<link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png">
		<link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png">
		<link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">
		<link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
		<link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
		<link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
		<link rel="manifest" href="/manifest.json">
		<meta name="msapplication-TileColor" content="#009688">
		<meta name="msapplication-TileImage" content="/mstile-144x144.png">
		<meta name="theme-color" content="#009688">
		<!-- favicon end -->
    <!-- <link href="/favicon.ico" rel="icon"> -->
  

  <!-- toc -->
  <link rel="stylesheet" href="/libs/tocify/jquery.tocify.css" media="screen" type="text/css">

  <!-- <link rel="stylesheet" href="/libs/bs/css/bootstrap.min.css" media="screen" type="text/css"> -->
  <link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap/3.3.4/css/bootstrap.min.css" media="screen" type="text/css">

  <!-- material design -->
	<!-- <link rel="stylesheet" href="/libs/bs-material/css/ripples.min.css" media="screen" type="text/css"> -->
  <link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/ripples.min.css" media="screen" type="text/css">
  <!-- <link rel="stylesheet" href="/libs/bs-material/css/material.min.css" media="screen" type="text/css"> -->
	<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/material.min.css" media="screen" type="text/css">

  <link rel="stylesheet" href="/css/highlight.light.css" media="screen" type="text/css">

  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">

  

  

  <script src="//apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script>
	<script>window.jQuery || document.write('<script src="/libs/jquery-2.0.3.min.js" type="text/javascript"><\/script>')</script>

</head>

 	<body>
	  <nav class="navbar navbar-default">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">菜单</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">agdragon&#39;s journal</a>
        </div>
        <div id="navbar" class="collapse navbar-collapse">
            <ul class="nav navbar-nav navbar-right">
                
                <li>
                    <a href="/" title="">
                    <i class="fa fa-home"></i>首页
                    </a>
                </li>
                
                <li>
                    <a href="/archives" title="">
                    <i class="fa fa-list"></i>存档
                    </a>
                </li>
                
            </ul>
        </div>
    </div>
</nav>

	  <div class="container" >
	    <div class="row">
	
	<div class="col-md-9 center-content">
	

		<div class="content">
			<!-- index -->
		   

			  		<h2>WSGI初探</h2>
					
					<div>
						<span class="post-time">2016-10-26 12:36:32</span>
					</div>
					

					<div class="article-content">
						<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>本文不涉及WSGI的具体协议的介绍，也不会有协议完整的实现，甚至描述中还会掺杂着本人自己对于WSGI的见解。所有的WSGI官方定义请看<a href="http://www.python.org/dev/peps/pep-3333/" target="_blank" rel="external">PEP3333</a>。</p>
<h2 id="WSGI是什么？"><a href="#WSGI是什么？" class="headerlink" title="WSGI是什么？"></a>WSGI是什么？</h2><p>WSGI的官方定义是，<strong>the Python Web Server Gateway Interface</strong>。从名字就可以看出来，这东西是一个Gateway，也就是网关。<strong>网关的作用就是在协议之间进行转换</strong>。</p>
<p>也就是说，WSGI就像是一座桥梁，一边连着web服务器，另一边连着用户的应用。但是呢，这个桥的功能很弱，有时候还需要别的桥来帮忙才能进行处理。</p>
<p>下面对本文出现的一些名词做定义:</p>
<pre><code>wsgi app，又称应用 ，就是一个WSGI application。
wsgi container ，又称容器 ，虽然这个部分常常被称为handler，不过我个人认为handler容易和app混淆，所以我称之为容器。
wsgi_middleware ，又称中间件。一种特殊类型的程序，专门负责在容器和应用之间干坏事的。
</code></pre><p>一图胜千言，直接来一个我自己理解的WSGI架构图吧</p>
<p><img src="http://static.oschina.net/uploads/img/201108/24153024_lr5b.jpg" alt=""></p>
<p>可以看出，服务器，容器和应用之间存在着十分纠结的关系。下面就要把这些纠结的关系理清楚。</p>
<h3 id="WSGI应用"><a href="#WSGI应用" class="headerlink" title="WSGI应用"></a>WSGI应用</h3><p>WSGI应用其实就是一个callable的对象。举一个最简单的例子，假设存在如下的一个应用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">def application(environ, start_response):  </div><div class="line">  status = &apos;200 OK&apos;</div><div class="line">  output = &apos;World!&apos;</div><div class="line">  response_headers = [(&apos;Content-type&apos;, &apos;text/plain&apos;),  </div><div class="line">                      (&apos;Content-Length&apos;, str(12)]  </div><div class="line">  write = start_response(status, response_headers)  </div><div class="line">  write(&apos;Hello &apos;)  </div><div class="line">  return [output]</div></pre></td></tr></table></figure>
<p>这个WSGI应用简单的可以用简陋来形容，但是他的确是一个功能完整的WSGI应用。只不过给人留下了太多的疑点，environ是什么？start_response是什么？为什么可以同时用write和return来返回内容？</p>
<p>对于这些疑问，不妨自己猜测一下他的作用。联想到CGI，那么environ可能就是一系列的环境变量，用来表示HTTP请求的信息，比如说method 之类的。start_response，可能是接受HTTP response头信息，然后返回一个write函数，这个write函数可以把HTTP response的body返回给客户端。return自然是将HTTP response的body信息返回。不过这里的write和函数返回有什么区别？会不会是其实外围默认调用write对应用返回值进行处理？而且为什么 应用的返回值是一个列表呢？说明肯定存在一个对应用执行结果的迭代输出过程。难道说他隐含的支持iterator或者generator吗？</p>
<p>等等，应用执行结果？一个应用既然是一个函数，说明肯定有一个对象去执行它，并且可以猜到，这个对象把environ和start_response传给应用，将应用的返回结果输出给客户端。那么这个对象是什么呢？自然就是WSGI容器了。</p>
<h3 id="WSGI容器"><a href="#WSGI容器" class="headerlink" title="WSGI容器"></a>WSGI容器</h3><p>先说说WSGI容器的来源，其实这是我自己编造出来的一个概念。来源就是JavaServlet容器。我个人理解两者有相似的地方，就顺手拿过来用了。</p>
<p>WSGI容器的作用，就是构建一个让WSGI应用成功执行的环境。成功执行，意味着需要传入正确的参数，以及正确处理返回的结果，还得把结果返回给客户端。</p>
<p>所以，WSGI容器的工作流程大致就是，用webserver规定的通信方式，能从webserver获得正确的request信息，封装好，传给WSGI应用执行，正确的返回response。</p>
<p>一般来说，WSGI容器必须依附于现有的webserver的技术才能实现，比如说CGI，FastCGI，或者是embed的模式。</p>
<p>下面利用CGI的方式编写一个最简单的WSGI容器。关于WSGI容器的协议官方文档并没有具体的说如何实现，只是介绍了一些需要约束的东西。具体内容看PEP3333中的协议。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div></pre></td><td class="code"><pre><div class="line">#!/usr/bin/python  </div><div class="line">#encoding:utf8  </div><div class="line"></div><div class="line">import cgi  </div><div class="line">import cgitb  </div><div class="line">import sys  </div><div class="line">import os  </div><div class="line"></div><div class="line">#Make the environ argument  </div><div class="line">environ = &#123;&#125;  </div><div class="line">environ[&apos;REQUEST_METHOD&apos;] = os.environ[&apos;REQUEST_METHOD&apos;]  </div><div class="line">environ[&apos;SCRIPT_NAME&apos;] = os.environ[&apos;SCRIPT_NAME&apos;]  </div><div class="line">environ[&apos;PATH_INFO&apos;] = os.environ[&apos;PATH_INFO&apos;]  </div><div class="line">environ[&apos;QUERY_STRING&apos;] = os.environ[&apos;QUERY_STRING&apos;]  </div><div class="line">environ[&apos;CONTENT_TYPE&apos;] = os.environ[&apos;CONTENT_TYPE&apos;]  </div><div class="line">environ[&apos;CONTENT_LENGTH&apos;] = os.environ[&apos;CONTENT_LENGTH&apos;]  </div><div class="line">environ[&apos;SERVER_NAME&apos;] = os.environ[&apos;SERVER_NAME&apos;]  </div><div class="line">environ[&apos;SERVER_PORT&apos;] = os.environ[&apos;SERVER_PORT&apos;]  </div><div class="line">environ[&apos;SERVER_PROTOCOL&apos;] = os.environ[&apos;SERVER_PROTOCOL&apos;]  </div><div class="line">environ[&apos;wsgi.version&apos;] = (1, 0)  </div><div class="line">environ[&apos;wsgi.url_scheme&apos;] = &apos;http&apos;</div><div class="line">environ[&apos;wsgi.input&apos;]        = sys.stdin  </div><div class="line">environ[&apos;wsgi.errors&apos;]       = sys.stderr  </div><div class="line">environ[&apos;wsgi.multithread&apos;]  = False</div><div class="line">environ[&apos;wsgi.multiprocess&apos;] = True</div><div class="line">environ[&apos;wsgi.run_once&apos;]     = True</div><div class="line"></div><div class="line"></div><div class="line">#make the start_response argument  </div><div class="line">#注意，WSGI协议规定，如果没有body内容，是不能返回http response头信息的。  </div><div class="line">sent_header = False</div><div class="line">res_status = None</div><div class="line">res_headers = None</div><div class="line"></div><div class="line">def write(body):  </div><div class="line">    global sent_header  </div><div class="line">    if sent_header:  </div><div class="line">        sys.stdout.write(body)  </div><div class="line">    else:  </div><div class="line">        print res_status  </div><div class="line">        for k, v in res_headers:  </div><div class="line">            print k + &apos;: &apos; + v  </div><div class="line">        print  </div><div class="line">        sys.stdout.write(body)  </div><div class="line">        sent_header = True</div><div class="line"></div><div class="line">def start_response(status, response_headers):  </div><div class="line">    global res_status  </div><div class="line">    global res_headers  </div><div class="line">    res_status = status  </div><div class="line">    res_headers = response_headers  </div><div class="line">    return write  </div><div class="line"></div><div class="line">#here is the application  </div><div class="line">  def application(environ, start_response):  </div><div class="line">    status = &apos;200 OK&apos;</div><div class="line">    output = &apos;World!&apos;</div><div class="line">    response_headers = [(&apos;Content-type&apos;, &apos;text/plain&apos;),  </div><div class="line">                        (&apos;Content-Length&apos;, str(12)]  </div><div class="line">    write = start_response(status, response_headers)  </div><div class="line">    write(&apos;Hello &apos;)  </div><div class="line">    return [output]  </div><div class="line"></div><div class="line">#here run the application  </div><div class="line">result = application(environ, start_response)  </div><div class="line">for value in result:   </div><div class="line">    write(value)</div></pre></td></tr></table></figure>
<p>看吧。其实实现一个WSGI容器也不难。</p>
<p>不过我从WSGI容器的设计中可以看出WSGI的应用设计上面存在着一个重大的问题就是：为什么要提供两种方式返回数据？明明只有一个write函数，却 既可以在application里面调用，又可以在容器中传输应用的返回值来调用。如果说让我来设计的话，直接把start_response给去掉了。 就用application(environ)这个接口。传一个方法，然后返回值就是status, response_headers和一个字符串的列表。实际传输的方法全部隐藏了。用户只需要从environ中读取数据处理就行了。。</p>
<p>可喜的是，搜了一下貌似web3的标准里面应用的设计和我的想法类似。希望web3协议能早日普及。<br>Middleware中间件</p>
<p>中间件是一类特殊的程序，可以在容器和应用之间干一些坏事。。其实熟悉python的decorator的人就会发现，这和decoraotr没什么区别。</p>
<p>下面来实现一个route的简单middleware。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">class Router(object):  </div><div class="line">    def __init__(self):  </div><div class="line">        self.path_info = &#123;&#125;  </div><div class="line">    def route(self, environ, start_response):  </div><div class="line">        application = self.path_info[environ[&apos;PATH_INFO&apos;]]  </div><div class="line">        return application(environ, start_response)  </div><div class="line">    def __call__(self, path):  </div><div class="line">        def wrapper(application):  </div><div class="line">            self.path_info[path] = application  </div><div class="line">        return wrapper</div></pre></td></tr></table></figure>
<p>这就是一个很简单的路由功能的middleware。将上面那段wsgi容器的代码里面的应用修改成如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">router = Router()  </div><div class="line"></div><div class="line">#here is the application  </div><div class="line">@router(&apos;/hello&apos;)  </div><div class="line">def hello(environ, start_response):  </div><div class="line">    status = &apos;200 OK&apos;</div><div class="line">    output = &apos;Hello&apos;</div><div class="line">    response_headers = [(&apos;Content-type&apos;, &apos;text/plain&apos;),  </div><div class="line">                        (&apos;Content-Length&apos;, str(len(output)))]  </div><div class="line">    write = start_response(status, response_headers)  </div><div class="line">    return [output]  </div><div class="line"></div><div class="line">@router(&apos;/world&apos;)  </div><div class="line">def world(environ, start_response):  </div><div class="line">    status = &apos;200 OK&apos;</div><div class="line">    output = &apos;World!&apos;</div><div class="line">    response_headers = [(&apos;Content-type&apos;, &apos;text/plain&apos;),  </div><div class="line">                        (&apos;Content-Length&apos;, str(len(output)))]  </div><div class="line">    write = start_response(status, response_headers)  </div><div class="line">    return [output]  </div><div class="line">#here run the application  </div><div class="line">result = router.route(environ, start_response)  </div><div class="line">for value in result:   </div><div class="line">    write(value)</div></pre></td></tr></table></figure>
<p>这样，容器就会自动的根据访问的地址找到对应的app执行了。</p>
<h2 id="延伸"><a href="#延伸" class="headerlink" title="延伸"></a>延伸</h2><p>写着写着，怎么越来越像一个框架了？看来Python开发框架真是简单。。</p>
<p>其实从另外一个角度去考虑。如果把application当作是一个运算单元。利用middleware调控IO和运算资源，那么利用WSGI组成一个分布式的系统。</p>

					</div>

			  <!-- about -->
			  
		</div>

		<!-- pagination -->
	  

		<!-- <div class="comment-section">
  
  


</div> -->

<section id="comment">
 <!-- 多说评论框 start -->
<div class="ds-thread" data-thread-key="2016/10/26/WSGI初探/" data-title="WSGI初探" data-url="http://agdragon.github.io/http://yoursite.com/2016/10/26/WSGI初探/"></div>
<!-- 多说评论框 end -->
<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
    var duoshuoQuery = {short_name:"agdragon"};
        (function() {
            var ds = document.createElement('script');
            ds.type = 'text/javascript';ds.async = true;
            ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
            ds.charset = 'UTF-8';
            (document.getElementsByTagName('head')[0]
             || document.getElementsByTagName('body')[0]).appendChild(ds);
        })();
</script>
<!-- 多说公共JS代码 end -->
</section>


	</div>

	

</div>


		<footer>
			

<!-- <p>
  由 <a href="https://hexo.io">hexo</a> 强力驱动 | 搭载 <a href="https://github.com/wayou/hexo-theme-material">material</a> 主题
</p>
<p>
  &copy; 2016 <a href="http://yoursite.com"> agdragon </a>
</p> -->

<!-- mac下“cmmand+/”注释html -->

<p>
  喜欢天空，麦田和海
</p>

<a id="gotop" href="#" title="back to top"><i class="mdi-hardware-keyboard-arrow-up"></i></a>

		</footer>
	  </div>

		<!-- <script src="/libs/bs/js/bootstrap.min.js"></script> -->
		<script src="//apps.bdimg.com/libs/bootstrap/3.3.4/js/bootstrap.min.js"></script>
		<script>(typeof $().modal == 'function')|| document.write('<script src="/libs/bs/js/bootstrap.min.js" type="text/javascript"><\/script>')</script>

		<!-- material design -->
		<!-- <script src="/libs/bs-material/js/ripples.min.js"></script> -->
		<script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/ripples.min.js"></script>
		<!-- <script src="/libs/bs-material/js/material.min.js"></script> -->
		<script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/material.min.js"></script>
		<!-- toc -->
		<!-- <script src="/libs/tocify/jquery-ui.min.js"></script> -->
		<script src="//apps.bdimg.com/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>
		<script src="/libs/tocify/jquery.tocify.custom.js"></script>

		<script src="/js/main.js"></script>

	</body>
</html>
